<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKOS Dictionary</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Additional styles for grouped results */
        .results-group {
            margin-bottom: 12px;
        }
        
        .results-group-title {
            background: #f0f0f0;
            padding: 4px 8px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 2px;
        }
        
        .results-group-items {
            display: grid;
            gap: 0;
        }
        
        /* Different styles for different label types */
        .concept-item.label-preferred {
            /* Default style - preferred labels */
        }
        
        .concept-item.label-alternative {
            font-style: italic;
            color: #666;
        }
                
        .concept-item.label-hidden {
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-left">
                    <h1 id="pageTitle">Title</h1>
                    <div class="subtitle" id="pageSubtitle">SubTitle</div>
                </div>
                <div class="language-selector">
                    <label for="uiLanguageSelect" id="uiLanguageLabel">UI:</label>
                    <select id="uiLanguageSelect"></select>
                    <label for="languageSelect" id="contentLanguageLabel">Content:</label>
                    <select id="languageSelect"></select>
                </div>
            </div>
        </header>

        <div class="main-content">
            <div class="left-panel">
                <div class="search-box">
                    <input type="search" id="searchInput" placeholder="Search for a concept..." autocomplete="off">
                </div>

                <div class="alphabet-nav" id="alphabetNav"></div>

                <div class="concept-list">
                    <div class="list-header" id="listTitle">Select a letter or search</div>
                    <div class="list-content" id="conceptItems">
                        <!-- Results will be grouped here -->
                    </div>
                </div>
            </div>

            <div class="concept-detail">
                <div class="empty-state" id="emptyState">
                    Select a concept to view its details
                </div>
                <div id="conceptDetail"></div>
            </div>
        </div>
    </div>

    <script>
        class SKOSClient {
            constructor() {
                this.currentLanguage = null;
                this.currentUILanguage = 'en';
                this.concepts = {};
                this.labelsToConceptId = {};
                this.metadata = {};
                this.translations = {
                    conceptsGroup: "Concepts",
                    alternativeFormsGroup: "Alternative forms",
                    variantsGroup: "Variants"
                };
                this.currentFilter = null;
                this.selectedConcept = null;
                this.searchTimeout = null;

                this.currentUILanguage = this.detectBrowserLocale();
                this.init();
            }

            detectBrowserLocale() {
                try {
                    const browserLang = navigator.language || navigator.userLanguage;
                    if (!browserLang) return 'en';
                    const langCode = browserLang.split('-')[0].toLowerCase();
                    return langCode;
                } catch (error) {
                    return 'en';
                }
            }

            getLanguageDisplayName(languageCode) {
                try {
                    const displayNames = new Intl.DisplayNames([this.currentUILanguage || 'en'], { type: 'language' });
                    return displayNames.of(languageCode);
                } catch (error) {
                    return languageCode.toUpperCase();
                }
            }

            async init() {
                this.parseURLParameters();
                await this.loadTranslations();
                await this.loadMetadata();
                await this.loadLanguageData(this.currentLanguage);
                this.setupEventListeners();
                this.generateAlphabet();
                this.updateUI();
                await this.handleURLConcept();
            }

            parseURLParameters() {
                const urlParams = new URLSearchParams(window.location.search);
                const uiLang = urlParams.get('ui') || urlParams.get('uilang');
                if (uiLang) this.currentUILanguage = uiLang;
                const contentLang = urlParams.get('lang');
                if (contentLang) this.currentLanguage = contentLang;
                this.urlConceptId = urlParams.get('concept') || urlParams.get('id');
            }

            async handleURLConcept() {
                if (this.urlConceptId && this.concepts[this.urlConceptId]) {
                    const url = new URL(window.location);
                    url.searchParams.delete('concept');
                    url.searchParams.delete('id');
                    window.history.replaceState({}, '', url);
                    this.selectedConcept = this.urlConceptId;
                    this.displayConceptDetail(this.concepts[this.urlConceptId]);
                }
            }

            async loadTranslations() {
                try {
                    const response = await fetch(`ui_translations_${this.currentUILanguage}.json`);
                    if (response.ok) {
                        const translations = await response.json();
                        Object.assign(this.translations, translations);
                    }
                } catch (error) {
                    console.log('Using default translations');
                }
                
                // Set default translations
                this.translations = Object.assign({
                    pageTitle: "Dictionary",
                    pageSubtitle: "Sectoral Dictionary",
                    uiLanguageLabel: "UI:",
                    contentLanguageLabel: "Content:",
                    searchPlaceholder: "Search...",
                    listTitle: "Select a letter or search",
                    emptyState: "Select a concept",
                    loading: "Loading...",
                    conceptsStartingWith: "Concepts starting with",
                    conceptsGroup: "Concepts",
                    alternativeFormsGroup: "Alternative forms",
                    variantsGroup: "Variants",
                    definition: "Definition",
                    altLabels: "Alternative labels",
                    broaderConcepts: "Broader concepts",
                    narrowerConcepts: "Narrower concepts",
                    relatedConcepts: "Related concepts",
                    examples: "Examples",
                    permalink: "Permalink"
                }, this.translations);
            }

            updateUI() {
                const titleEl = document.getElementById('pageTitle');
                const subtitleEl = document.getElementById('pageSubtitle');
                
                let title = null;
                if (this.metadata?.title && typeof this.metadata.title === 'object') {
                    title = this.metadata.title[this.currentLanguage] || 
                            this.metadata.title[this.currentUILanguage] || 
                            this.metadata.title["no-lang"];
                }
                titleEl.textContent = title || this.translations.pageTitle;
                
                let description = null;
                if (this.metadata?.description && typeof this.metadata.description === 'object') {
                    description = this.metadata.description[this.currentLanguage] || 
                                 this.metadata.description[this.currentUILanguage] || 
                                 this.metadata.description["no-lang"];
                }
                subtitleEl.textContent = description || this.translations.pageSubtitle;
                
                document.getElementById('uiLanguageLabel').textContent = this.translations.uiLanguageLabel;
                document.getElementById('contentLanguageLabel').textContent = this.translations.contentLanguageLabel;
                document.getElementById('searchInput').placeholder = this.translations.searchPlaceholder;
                document.getElementById('listTitle').textContent = this.translations.listTitle;
                document.getElementById('emptyState').textContent = this.translations.emptyState;
                document.documentElement.lang = this.currentUILanguage;
            }

            async loadMetadata() {
                try {
                    const response = await fetch('thesaurus_metadata.json');
                    this.metadata = await response.json();
                    
                    if (!this.currentLanguage) {
                        let availableLanguages = this.metadata.available_languages || ['en'];
                        if (typeof availableLanguages[0] === 'object') {
                            availableLanguages = availableLanguages.map(l => l.code);
                        }
                        this.currentLanguage = availableLanguages[0];
                    }
                    this.populateLanguageSelectors();
                } catch (error) {
                    this.metadata = {
                        available_languages: ['en'],
                        ui_languages: ['en']
                    };
                    if (!this.currentLanguage) this.currentLanguage = 'en';
                    this.populateLanguageSelectors();
                }
            }

            populateLanguageSelectors() {
                const contentSelector = document.getElementById('languageSelect');
                const uiSelector = document.getElementById('uiLanguageSelect');
                if (!contentSelector || !uiSelector) return;
                
                contentSelector.innerHTML = '';
                let availableLanguages = this.metadata.available_languages || ['en'];
                if (typeof availableLanguages[0] === 'object') {
                    availableLanguages = availableLanguages.map(l => l.code);
                }
                availableLanguages.forEach(langCode => {
                    const option = document.createElement('option');
                    option.value = langCode;
                    option.textContent = this.getLanguageDisplayName(langCode);
                    if (langCode === this.currentLanguage) option.selected = true;
                    contentSelector.appendChild(option);
                });
                
                uiSelector.innerHTML = '';
                let uiLanguages = this.metadata.ui_languages || this.metadata.available_languages || ['en'];
                if (typeof uiLanguages[0] === 'object') {
                    uiLanguages = uiLanguages.map(l => l.code);
                }
                uiLanguages.forEach(langCode => {
                    const option = document.createElement('option');
                    option.value = langCode;
                    option.textContent = this.getLanguageDisplayName(langCode);
                    if (langCode === this.currentUILanguage) option.selected = true;
                    uiSelector.appendChild(option);
                });
            }

            async loadLanguageData(languageCode) {
                try {
                    if (!languageCode) languageCode = 'en';
                    
                    document.getElementById('conceptItems').innerHTML = 
                        `<div class="loading">${this.translations.loading}</div>`;
                    
                    const [conceptsResponse, labelsResponse] = await Promise.all([
                        fetch(`concepts_${languageCode}.json`),
                        fetch(`labels_to_concept_${languageCode}.json`)
                    ]);
                    
                    this.concepts = await conceptsResponse.json();
                    this.labelsToConceptId = await labelsResponse.json();
                    
                    this.clearResults();
                } catch (error) {
                    console.error('Error loading data:', error);
                    document.getElementById('conceptItems').innerHTML = 
                        `<div class="empty-state">Error loading data</div>`;
                }
            }

            setupEventListeners() {
                document.getElementById('uiLanguageSelect').addEventListener('change', async (e) => {
                    this.currentUILanguage = e.target.value;
                    await this.loadTranslations();
                    this.updateUI();
                    this.populateLanguageSelectors();
                });
                
                document.getElementById('languageSelect').addEventListener('change', async (e) => {
                    this.currentLanguage = e.target.value;
                    await this.loadLanguageData(this.currentLanguage);
                });
                
                const searchInput = document.getElementById('searchInput');
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(() => {
                        this.handleSearch(e.target.value);
                    }, 300); // Debounce 300ms
                });
            }

            generatePermalink(conceptId) {
                const url = new URL(window.location);
                url.searchParams.set('concept', conceptId);
                url.searchParams.set('lang', this.currentLanguage);
                if (this.currentUILanguage !== 'en') {
                    url.searchParams.set('ui', this.currentUILanguage);
                }
                return url.toString();
            }

            handleSearch(query) {
                if (!query.trim()) {
                    this.clearResults();
                    return;
                }
                
                const matchingLabels = Object.keys(this.labelsToConceptId)
                    .filter(label => label.substring(1).toLowerCase().includes(query.toLowerCase()))
                    .sort();
                
                const title = `${matchingLabels.length} results for "${query}"`;
                this.displayGroupedResults(matchingLabels, title);
            }

            generateAlphabet() {
                const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
                const nav = document.getElementById('alphabetNav');
                nav.innerHTML = '';
                alphabet.forEach(letter => {
                    const button = document.createElement('button');
                    button.textContent = letter;
                    button.addEventListener('click', () => this.filterByLetter(letter));
                    nav.appendChild(button);
                });
            }

            filterByLetter(letter) {
                document.querySelectorAll('.alphabet-nav button').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                const matchingLabels = Object.keys(this.labelsToConceptId)
                    .filter(label => label.substring(1).toLowerCase().startsWith(letter.toLowerCase()))
                    .sort();
                
                const title = `${this.translations.conceptsStartingWith} "${letter}"`;
                this.displayGroupedResults(matchingLabels, title);
            }

            displayGroupedResults(labels, title) {
                const titleElement = document.getElementById('listTitle');
                const container = document.getElementById('conceptItems');
                
                titleElement.textContent = title;
                container.innerHTML = '';
                
                if (labels.length === 0) {
                    container.innerHTML = '<div class="empty-state">No results found</div>';
                    return;
                }
                
                // Group labels by type
                const groups = {
                    p: { title: this.translations.conceptsGroup, labels: [] },
                    a: { title: this.translations.alternativeFormsGroup, labels: [] },
                    h: { title: this.translations.variantsGroup, labels: [] }
                };
                
                labels.forEach(label => {
                    const firstChar = label.charAt(0).toLowerCase();
                    if (groups[firstChar]) {
                        groups[firstChar].labels.push(label);
                    }
                });
                
                // Render groups in order: p, a, h
                ['p', 'a', 'h'].forEach(type => {
                    const group = groups[type];
                    if (group.labels.length > 0) {
                        this.renderGroup(group.title, group.labels, type, container);
                    }
                });
            }

            renderGroup(title, labels, type, container) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'results-group';
                
                const groupTitle = document.createElement('div');
                groupTitle.className = 'results-group-title';
                groupTitle.textContent = `${title} (${labels.length})`;
                groupDiv.appendChild(groupTitle);
                
                const itemsGrid = document.createElement('div');
                itemsGrid.className = 'results-group-items';
                
                labels.forEach(label => {
                    const item = document.createElement('div');
                    item.className = 'concept-item';
                    
                    var displayText = label.substring(1);
                    const conceptId = this.labelsToConceptId[label];
                    
                    if (type === 'p') {
                        item.classList.add('label-preferred');
                        item.textContent = displayText;
                    } else if (type === 'a') {
                        item.classList.add('label-alternative');
                        const concept = this.concepts[conceptId];
                        
                        if (concept) {
                            item.innerHTML += `${displayText}<b>â†’ ${concept.prefLabel}</b>`;
                        }
                    } else if (type === 'h') {
                        item.classList.add('label-hidden');
                        const concept = this.concepts[conceptId];
                        item.textContent = displayText;
                        if (concept) {
                            item.title = `Hidden variant of: ${concept.prefLabel}`;
                        }
                    }
                    
                    item.addEventListener('click', () => {
                        this.selectConceptByLabel(label);
                        // Highlight selected
                        document.querySelectorAll('.concept-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                    });
                    
                    itemsGrid.appendChild(item);
                });
                
                groupDiv.appendChild(itemsGrid);
                container.appendChild(groupDiv);
            }

            selectConceptByLabel(label) {
                const conceptId = this.labelsToConceptId[label];
                if (!conceptId || !this.concepts[conceptId]) {
                    console.error('Concept not found:', label);
                    return;
                }
                this.selectedConcept = conceptId;
                this.displayConceptDetail(this.concepts[conceptId]);
            }

            displayConceptDetail(concept) {
                const emptyState = document.getElementById('emptyState');
                const detailContainer = document.getElementById('conceptDetail');
                
                emptyState.style.display = 'none';
                detailContainer.style.display = 'block';
                
                let html = `<div class="concept-title">${concept.prefLabel}</div>`;
                
                if (this.selectedConcept) {
                    const permalink = this.generatePermalink(this.selectedConcept);
                    html += `
                        <div class="permalink">
                            <strong>${this.translations.permalink}:</strong><br>
                            <code>${permalink}</code>
                        </div>
                    `;
                }
                
                if (concept.definition?.length > 0) {
                    html += `
                        <div class="concept-section">
                            <div class="section-title">${this.translations.definition}:</div>
                            <div class="section-content">
                                ${concept.definition.map(def => `<p>${def}</p>`).join('')}
                            </div>
                        </div>
                    `;
                }
                
                if (concept.altLabel?.length > 0) {
                    html += `
                        <div class="concept-section">
                            <div class="section-title">${this.translations.altLabels}:</div>
                            <div class="section-content">
                                ${concept.altLabel.join(', ')}
                            </div>
                        </div>
                    `;
                }
                
                if (concept.example?.length > 0) {
                    html += `
                        <div class="concept-section">
                            <div class="section-title">${this.translations.examples}:</div>
                            <div class="section-content">
                                ${concept.example.map(ex => `<p>${ex}</p>`).join('')}
                            </div>
                        </div>
                    `;
                }
                
                if (concept.broaderConcept?.length > 0) {
                    html += `
                        <div class="concept-section">
                            <div class="section-title">${this.translations.broaderConcepts}:</div>
                            <div class="section-content">
                                <div class="relations">
                                    ${this.renderConceptRelations(concept.broaderConcept)}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (concept.narrowerConcept?.length > 0) {
                    html += `
                        <div class="concept-section">
                            <div class="section-title">${this.translations.narrowerConcepts}:</div>
                            <div class="section-content">
                                <div class="relations">
                                    ${this.renderConceptRelations(concept.narrowerConcept)}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (concept.related?.length > 0) {
                    html += `
                        <div class="concept-section">
                            <div class="section-title">${this.translations.relatedConcepts}:</div>
                            <div class="section-content">
                                <div class="relations">
                                    ${this.renderConceptRelations(concept.related)}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                detailContainer.innerHTML = html;
                
                document.querySelectorAll('.relation-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const conceptId = item.dataset.conceptId;
                        if (this.concepts[conceptId]) {
                            this.selectedConcept = conceptId;
                            this.displayConceptDetail(this.concepts[conceptId]);
                        }
                    });
                });
            }

            renderConceptRelations(relations) {
                return relations.map(relation => {
                    let label, conceptId;
                    if (typeof relation === 'object') {
                        label = Object.keys(relation)[0];
                        conceptId = Object.values(relation)[0];
                    } else {
                        conceptId = relation;
                        const conceptData = this.concepts[conceptId];
                        label = conceptData ? conceptData.prefLabel : conceptId;
                    }
                    return `<span class="relation-item" data-concept-id="${conceptId}">${label}</span>`;
                }).join('');
            }

            clearResults() {
                document.getElementById('listTitle').textContent = this.translations.listTitle;
                document.getElementById('conceptItems').innerHTML = '';
                document.querySelectorAll('.alphabet-nav button').forEach(btn => {
                    btn.classList.remove('active');
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new SKOSClient();
        });
    </script>
</body>
</html>