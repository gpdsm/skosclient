<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>§title §description</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
            color: #333;
            background-color: #fafafa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #fff;
            border-bottom: 3px solid #2c5f7c;
            margin-bottom: 30px;
            padding: 30px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-content {
            text-align: center;
        }

        h1 {
            color: #2c5f7c;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: normal;
        }

        .subtitle {
            color: #666;
            font-style: italic;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .language-selector {
            margin-bottom: 20px;
        }

        .language-selector select {
            padding: 8px 15px;
            border: 2px solid #2c5f7c;
            border-radius: 4px;
            font-size: 1rem;
            background: white;
            color: #2c5f7c;
            margin: 0 5px;
        }

        .search-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .concept-list .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .concept-list .search-box #searchInput {
            width: 100%;
            padding: 12px 15px;
            font-size: 1rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            transition: border-color 0.3s;
        }

        .concept-list .search-box #searchInput:focus {
            outline: none;
            border-color: #2c5f7c;
        }

        .concept-list .search-box #searchSuggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .suggestion-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .suggestion-item:hover,
        .suggestion-item.highlighted {
            background-color: #e8f4f8;
            border-left: 4px solid #2c5f7c;
        }

        .alphabet-nav {
            text-align: center;
            margin-bottom: 30px;
        }

        .alphabet-nav button {
            background: #2c5f7c;
            color: white;
            border: none;
            padding: 8px 12px;
            margin: 2px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .alphabet-nav button:hover {
            background-color: #1a4a5a;
        }

        .alphabet-nav button.active {
            background-color: #4a7c9a;
        }

        .content-area {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            align-items: start;
        }

        .concept-list {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 600px;
            overflow-y: auto;
        }

        .concept-list h3 {
            color: #2c5f7c;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .concept-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .concept-item:hover {
            background-color: #f9f9f9;
            padding-left: 10px;
        }

        .concept-item.selected {
            background-color: #e8f4f8;
            padding-left: 10px;
            border-left: 4px solid #2c5f7c;
        }

        .concept-detail {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 400px;
        }

        .concept-title {
            color: #2c5f7c;
            font-size: 1.8rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2c5f7c;
        }

        .concept-section {
            margin-bottom: 25px;
        }

        .section-title {
            font-weight: bold;
            color: #2c5f7c;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .section-content {
            margin-left: 15px;
            line-height: 1.7;
        }

        .relation-item {
            background: #f8f9fa;
            padding: 8px 12px;
            margin: 5px 0;
            border-left: 4px solid #2c5f7c;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .relation-item:hover {
            background-color: #e9ecef;
        }

        .empty-state {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 50px 20px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .permalink {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-size: 0.9rem;
            margin-bottom: 15px;
            word-break: break-all;
        }

        .permalink code {
            background: none;
            color: #2c5f7c;
        }

        @media (max-width: 768px) {
            .content-area {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .concept-detail {
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1 id="pageTitle">DiSMI</h1>
                <div class="subtitle" id="pageSubtitle">Dizionario Settoriale delle Scienze dell'Informazione</div>
                <div class="language-selector">
                    <label for="uiLanguageSelect" id="uiLanguageLabel">Interface language:</label>
                    <select id="uiLanguageSelect">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                    <label for="languageSelect" id="contentLanguageLabel">Content language:</label>
                    <select id="languageSelect">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>
        </header>

        <div class="search-section">
            <div class="alphabet-nav" id="alphabetNav">
                <!-- Le lettere verranno generate dinamicamente -->
            </div>
        </div>

        <div class="content-area">
            <div class="concept-list">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search for a concept...">
                    <div id="searchSuggestions"></div>
                </div>
                <h3 id="listTitle">Select a letter or search for a concept</h3>
                <div id="conceptItems"></div>
            </div>

            <div class="concept-detail">
                <div class="empty-state" id="emptyState">
                    Select a concept from the list to view its details
                </div>
                <div id="conceptDetail" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        class SKOSClient {
            constructor() {
                this.currentLanguage = 'en'; // Default content language
                this.currentUILanguage = 'en'; // Will be set by detectBrowserLocale
                this.concepts = {};
                this.labelsToConceptId = {};
                this.metadata = {};
                this.translations = {};
                this.currentFilter = null;
                this.selectedConcept = null;
                this.currentSuggestions = [];
                this.highlightedIndex = -1;

                // Detect browser locale after initialization
                this.currentUILanguage = this.detectBrowserLocale();

                this.init();
            }

            detectBrowserLocale() {
                try {
                    // Get browser language, fallback to English
                    const browserLang = navigator.language || navigator.userLanguage;
                    if (!browserLang) return 'en';
                    
                    // Extract just the language code (e.g., 'it' from 'it-IT')
                    const langCode = browserLang.split('-')[0].toLowerCase();
                    
                    // For now, support only 'it' and 'en', fallback to 'en'
                    return ['it', 'en','de'].includes(langCode) ? langCode : 'en';
                } catch (error) {
                    console.warn('Error detecting browser locale:', error);
                    return 'en';
                }
            }

            getLanguageDisplayName(languageCode, displayLanguage = null) {
                try {
                    // Use the UI language for displaying language names, or fallback to the provided language
                    const displayLang = displayLanguage || this.currentUILanguage || 'en';
                    const displayNames = new Intl.DisplayNames([displayLang], { type: 'language' });
                    return displayNames.of(languageCode);
                } catch (error) {
                    console.warn(`Could not get display name for ${languageCode}:`, error);
                    // Fallback to language code if Intl.DisplayNames fails
                    return languageCode.toUpperCase();
                }
            }

            async init() {
                // Parse URL parameters first
                this.parseURLParameters();
                
                await this.loadTranslations();
                await this.loadMetadata();
                await this.loadLanguageData(this.currentLanguage);
                this.setupEventListeners();
                this.generateAlphabet();
                this.updateUI(); // Call after metadata is loaded

                // Handle direct concept loading from URL
                await this.handleURLConcept();
            }

            parseURLParameters() {
                const urlParams = new URLSearchParams(window.location.search);
                
                // Get UI language from URL, fallback to auto-detected
                const uiLang = urlParams.get('ui') || urlParams.get('uilang');
                if (uiLang && ['it', 'en'].includes(uiLang)) {
                    this.currentUILanguage = uiLang;
                }

                // Get content language from URL, keep default if not specified
                const contentLang = urlParams.get('lang');
                if (contentLang) {
                    this.currentLanguage = contentLang;
                }

                // Store concept ID for later loading
                this.urlConceptId = urlParams.get('concept') || urlParams.get('id');
                
                console.log('Parsed URL params:', {
                    uiLang: this.currentUILanguage,
                    contentLang: this.currentLanguage,
                    conceptId: this.urlConceptId
                });
            }

            async handleURLConcept() {
                if (this.urlConceptId && this.concepts[this.urlConceptId]) {
                    // Update the URL to remove the concept parameter after loading
                    const url = new URL(window.location);
                    url.searchParams.delete('concept');
                    url.searchParams.delete('id');
                    window.history.replaceState({}, '', url);
                    
                    // Load the concept
                    this.selectedConcept = this.urlConceptId;
                    this.displayConceptDetail(this.concepts[this.urlConceptId]);
                    
                    // Update the search input with the concept's preferred label
                    document.getElementById('searchInput').value = this.concepts[this.urlConceptId].prefLabel;
                }
            }

            async loadTranslations() {
                try {
                    // Ensure we have a valid UI language
                    if (!this.currentUILanguage || !['it', 'en'].includes(this.currentUILanguage)) {
                        this.currentUILanguage = 'en';
                    }

                    const response = await fetch(`ui_translations_${this.currentUILanguage}.json`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    this.translations = await response.json();
                    console.log(`Loaded ${this.currentUILanguage} translations successfully`);
                } catch (error) {
                    console.error('Error loading translations:', error);
                    // Fallback to English translations
                    this.translations = {
                        "pageTitle": "DiSMI",
                        "pageSubtitle": "Sectoral Dictionary of Information Sciences",
                        "uiLanguageLabel": "Interface language:",
                        "contentLanguageLabel": "Content language:",
                        "searchPlaceholder": "Search for a concept...",
                        "listTitle": "Select a letter or search for a concept",
                        "emptyState": "Select a concept from the list to view its details",
                        "loading": "Loading...",
                        "loadingError": "Error loading data",
                        "noConceptsFound": "No concepts found",
                        "conceptsStartingWith": "Concepts starting with",
                        "definition": "Definition",
                        "altLabels": "Alternative labels",
                        "broaderConcepts": "Broader concepts",
                        "narrowerConcepts": "Narrower concepts",
                        "relatedConcepts": "Related concepts",
                        "notes": "Notes",
                        "scopeNotes": "Scope notes",
                        "historyNotes": "History notes",
                        "editorialNotes": "Editorial notes",
                        "examples": "Examples",
                        "permalink": "Permalink"
                    };
                    console.log('Using fallback English translations');
                }
            }

            updateUI() {
                // Update page title and subtitle if provided in metadata
                if (this.metadata.title && typeof this.metadata.title === 'string') {
                    document.getElementById('pageTitle').textContent = this.metadata.title;
                } else {
                    document.getElementById('pageTitle').textContent = this.translations.pageTitle || 'DiSMI';
                }

                if (this.metadata.description && typeof this.metadata.description === 'string') {
                    document.getElementById('pageSubtitle').textContent = this.metadata.description;
                } else {
                    document.getElementById('pageSubtitle').textContent = this.translations.pageSubtitle || 'Sectoral Dictionary of Information Sciences';
                }

                // Update other UI elements
                document.getElementById('uiLanguageLabel').textContent = this.translations.uiLanguageLabel || 'Interface language:';
                document.getElementById('contentLanguageLabel').textContent = this.translations.contentLanguageLabel || 'Content language:';
                document.getElementById('searchInput').placeholder = this.translations.searchPlaceholder || 'Search for a concept...';
                document.getElementById('listTitle').textContent = this.translations.listTitle || 'Select a letter or search for a concept';
                document.getElementById('emptyState').textContent = this.translations.emptyState || 'Select a concept from the list to view its details';

                // Update HTML lang attribute
                document.documentElement.lang = this.currentUILanguage;
            }

            async loadMetadata() {
                try {
                    const response = await fetch('thesaurus_metadata.json');
                    this.metadata = await response.json();
                    console.log('Loaded metadata:', this.metadata);
                    this.populateLanguageSelectors();
                } catch (error) {
                    console.error('Error loading metadata:', error);
                    // Fallback metadata structure with just language codes
                    this.metadata = { 
                        title: "DiSMI",
                        description: "Sectoral Dictionary of Information Sciences",
                        available_languages: ['en', 'it'],
                        ui_languages: ['en', 'it']
                    };
                    console.log('Using fallback metadata');
                    this.populateLanguageSelectors();
                }
            }

            populateLanguageSelectors() {
                console.log('Populating language selectors with metadata:', this.metadata);
                
                // Check if DOM elements exist
                const contentSelector = document.getElementById('languageSelect');
                const uiSelector = document.getElementById('uiLanguageSelect');
                
                if (!contentSelector || !uiSelector) {
                    console.error('Language selector elements not found in DOM');
                    return;
                }
                
                // Populate content language selector
                contentSelector.innerHTML = '';
                
                // Handle both old format (objects with name/code) and new format (array of strings)
                let availableLanguages = this.metadata.available_languages || this.metadata.languages || ['en'];
                
                // Convert old format to new format if needed
                if (availableLanguages.length > 0 && typeof availableLanguages[0] === 'object') {
                    availableLanguages = availableLanguages.map(lang => lang.code);
                }
                
                console.log('Available languages (codes):', availableLanguages);
                
                availableLanguages.forEach(langCode => {
                    const option = document.createElement('option');
                    option.value = langCode;
                    option.textContent = this.getLanguageDisplayName(langCode);
                    if (langCode === this.currentLanguage) {
                        option.selected = true;
                    }
                    contentSelector.appendChild(option);
                    console.log(`Added content language option: ${option.textContent} (${langCode})`);
                });

                // Populate UI language selector  
                uiSelector.innerHTML = '';
                
                // Handle both old format and new format
                let uiLanguages = this.metadata.ui_languages || this.metadata.available_languages || this.metadata.languages || ['en', 'it'];
                
                // Convert old format to new format if needed
                if (uiLanguages.length > 0 && typeof uiLanguages[0] === 'object') {
                    uiLanguages = uiLanguages.map(lang => lang.code);
                }
                
                console.log('UI languages (codes):', uiLanguages);
                
                uiLanguages.forEach(langCode => {
                    const option = document.createElement('option');
                    option.value = langCode;
                    option.textContent = this.getLanguageDisplayName(langCode);
                    if (langCode === this.currentUILanguage) {
                        option.selected = true;
                    }
                    uiSelector.appendChild(option);
                    console.log(`Added UI language option: ${option.textContent} (${langCode})`);
                });

                console.log('Language selectors populated successfully');
                console.log('Content selector options count:', contentSelector.options.length);
                console.log('UI selector options count:', uiSelector.options.length);
            }

            async loadLanguageData(languageCode) {
                try {
                    // Ensure we have a valid language code
                    if (!languageCode) {
                        languageCode = 'en';
                        this.currentLanguage = 'en';
                    }

                    console.log(`Loading data for language: ${languageCode}`);
                    
                    const loadingText = this.translations.loading || 'Loading...';
                    document.getElementById('conceptItems').innerHTML = `<div class="loading">${loadingText}</div>`;
                    
                    const [conceptsResponse, labelsResponse] = await Promise.all([
                        fetch(`concepts_${languageCode}.json`),
                        fetch(`labels_to_concept_${languageCode}.json`)
                    ]);

                    if (!conceptsResponse.ok) {
                        throw new Error(`Failed to load concepts_${languageCode}.json: ${conceptsResponse.status}`);
                    }
                    if (!labelsResponse.ok) {
                        throw new Error(`Failed to load labels_to_concept_${languageCode}.json: ${labelsResponse.status}`);
                    }

                    this.concepts = await conceptsResponse.json();
                    this.labelsToConceptId = await labelsResponse.json();
                    
                    console.log(`Loaded ${Object.keys(this.concepts).length} concepts and ${Object.keys(this.labelsToConceptId).length} labels`);
                    
                    this.clearConceptList();
                    this.clearConceptDetail();
                } catch (error) {
                    console.error('Error loading language data:', error);
                    const errorText = this.translations.loadingError || 'Error loading data';
                    document.getElementById('conceptItems').innerHTML = `<div class="empty-state">${errorText}<br><small>${error.message}</small></div>`;
                }
            }

            setupEventListeners() {
                // UI Language selector
                document.getElementById('uiLanguageSelect').addEventListener('change', async (e) => {
                    this.currentUILanguage = e.target.value;
                    await this.loadTranslations();
                    this.updateUI();
                    // Repopulate selectors to show language names in the new UI language
                    this.populateLanguageSelectors();
                });

                // Content Language selector
                document.getElementById('languageSelect').addEventListener('change', async (e) => {
                    this.currentLanguage = e.target.value;
                    await this.loadLanguageData(this.currentLanguage);
                });

                // Search input
                const searchInput = document.getElementById('searchInput');
                
                searchInput.addEventListener('input', (e) => {
                    this.handleSearch(e.target.value);
                });

                searchInput.addEventListener('keydown', (e) => {
                    this.handleSearchKeydown(e);
                });

                searchInput.addEventListener('focus', () => {
                    if (searchInput.value && this.currentSuggestions.length > 0) {
                        document.getElementById('searchSuggestions').style.display = 'block';
                    }
                });

                // Hide suggestions when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.search-box')) {
                        this.hideSuggestions();
                    }
                });
            }

            generatePermalink(conceptId) {
                const baseUrl = window.location.origin + window.location.pathname;
                const url = new URL(baseUrl);
                url.searchParams.set('concept', conceptId);
                url.searchParams.set('lang', this.currentLanguage);
                if (this.currentUILanguage !== 'it') {
                    url.searchParams.set('ui', this.currentUILanguage);
                }
                return url.toString();
            }

            handleSearch(query) {
                if (!query.trim()) {
                    this.hideSuggestions();
                    this.clearConceptDetail();
                    return;
                }

                this.showSuggestions(query);
            }

            handleSearchKeydown(e) {
                const container = document.getElementById('searchSuggestions');
                
                if (container.style.display === 'none' || this.currentSuggestions.length === 0) {
                    return;
                }

                switch(e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        this.highlightedIndex++;
                        if (this.highlightedIndex >= this.currentSuggestions.length) {
                            this.highlightedIndex = 0;
                        }
                        this.updateHighlight();
                        this.updateConceptDetail();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        this.highlightedIndex--;
                        if (this.highlightedIndex < 0) {
                            this.highlightedIndex = this.currentSuggestions.length - 1;
                        }
                        this.updateHighlight();
                        this.updateConceptDetail();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (this.highlightedIndex >= 0) {
                            const selectedLabel = this.currentSuggestions[this.highlightedIndex];
                            document.getElementById('searchInput').value = selectedLabel;
                            this.hideSuggestions();
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        this.hideSuggestions();
                        break;
                    default:
                        return;
                }
            }

            showSuggestions(query) {
                const suggestions = this.findMatchingLabels(query.toLowerCase());
                const container = document.getElementById('searchSuggestions');
                
                if (suggestions.length === 0) {
                    this.hideSuggestions();
                    return;
                }

                this.currentSuggestions = suggestions.slice(0, 10);
                this.highlightedIndex = 0;

                container.innerHTML = '';
                this.currentSuggestions.forEach((label, index) => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = label;
                    
                    item.addEventListener('click', () => {
                        this.selectConceptByLabel(label);
                        document.getElementById('searchInput').value = label;
                        this.hideSuggestions();
                    });

                    item.addEventListener('mouseenter', () => {
                        this.highlightedIndex = index;
                        this.updateHighlight();
                        this.updateConceptDetail();
                    });

                    container.appendChild(item);
                });

                container.style.display = 'block';
                this.updateHighlight();
                this.updateConceptDetail();
            }

            updateHighlight() {
                const items = document.querySelectorAll('.suggestion-item');
                items.forEach((item, index) => {
                    if (index === this.highlightedIndex) {
                        item.classList.add('highlighted');
                        item.scrollIntoView({ block: 'nearest' });
                    } else {
                        item.classList.remove('highlighted');
                    }
                });
            }

            updateConceptDetail() {
                if (this.highlightedIndex >= 0 && this.highlightedIndex < this.currentSuggestions.length) {
                    const selectedLabel = this.currentSuggestions[this.highlightedIndex];
                    this.selectConceptByLabel(selectedLabel, false);
                }
            }

            hideSuggestions() {
                document.getElementById('searchSuggestions').style.display = 'none';
                this.currentSuggestions = [];
                this.highlightedIndex = -1;
            }

            findMatchingLabels(query) {
                return Object.keys(this.labelsToConceptId)
                    .filter(label => label.toLowerCase().includes(query))
                    .sort();
            }

            generateAlphabet() {
                const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
                const nav = document.getElementById('alphabetNav');
                nav.innerHTML = '';

                alphabet.forEach(letter => {
                    const button = document.createElement('button');
                    button.textContent = letter;
                    button.addEventListener('click', () => this.filterByLetter(letter));
                    nav.appendChild(button);
                });
            }

            filterByLetter(letter) {
                document.querySelectorAll('.alphabet-nav button').forEach(btn => {
                    btn.classList.remove('active');
                });

                event.target.classList.add('active');

                this.currentFilter = letter.toLowerCase();
                const matchingConcepts = this.getConceptsByLetter(letter);
                const title = `${this.translations.conceptsStartingWith || 'Concetti che iniziano con'} "${letter}"`;
                this.displayConceptList(matchingConcepts, title);
            }

            getConceptsByLetter(letter) {
                return Object.keys(this.labelsToConceptId)
                    .filter(label => label.toLowerCase().startsWith(letter.toLowerCase()))
                    .sort()
                    .map(label => ({
                        label,
                        conceptId: this.labelsToConceptId[label]
                    }));
            }

            displayConceptList(concepts, title) {
                const titleElement = document.getElementById('listTitle');
                const itemsContainer = document.getElementById('conceptItems');

                titleElement.textContent = title;
                itemsContainer.innerHTML = '';

                if (concepts.length === 0) {
                    const noResultsText = this.translations.noConceptsFound || 'Nessun concetto trovato';
                    itemsContainer.innerHTML = `<div class="empty-state">${noResultsText}</div>`;
                    return;
                }

                concepts.forEach(({ label, conceptId }) => {
                    const item = document.createElement('div');
                    item.className = 'concept-item';
                    item.textContent = label;
                    item.addEventListener('click', () => this.selectConcept(label, item));
                    itemsContainer.appendChild(item);
                });
            }

            selectConcept(label, itemElement = null) {
                const conceptId = this.labelsToConceptId[label];
                if (!conceptId || !this.concepts[conceptId]) {
                    console.error('Concetto non trovato:', label);
                    return;
                }

                document.querySelectorAll('.concept-item').forEach(item => {
                    item.classList.remove('selected');
                });
                if (itemElement) {
                    itemElement.classList.add('selected');
                }

                this.selectedConcept = conceptId;
                this.displayConceptDetail(this.concepts[conceptId]);
            }

            selectConceptByLabel(label, hideSuggestions = true) {
                const conceptId = this.labelsToConceptId[label];
                if (!conceptId || !this.concepts[conceptId]) {
                    console.error('Concetto non trovato:', label);
                    return;
                }

                this.selectedConcept = conceptId;
                this.displayConceptDetail(this.concepts[conceptId]);
                
                if (hideSuggestions) {
                    this.hideSuggestions();
                }
            }

            displayConceptDetail(concept) {
                const emptyState = document.getElementById('emptyState');
                const detailContainer = document.getElementById('conceptDetail');

                emptyState.style.display = 'none';
                detailContainer.style.display = 'block';

                let html = `<div class="concept-title">${concept.prefLabel}</div>`;

                // Add permalink
                if (this.selectedConcept) {
                    const permalink = this.generatePermalink(this.selectedConcept);
                    html += `
                        <div class="permalink">
                            <strong>${this.translations.permalink || 'Link diretto'}:</strong><br>
                            <code>${permalink}</code>
                        </div>
                    `;
                }

                // Definition
                if (concept.definition && concept.definition.length > 0) {
                    html += `
                        <div class="concept-section">
                            <div class="section-title">${this.translations.definition || 'Definizione'}:</div>
                            <div class="section-content">
                                ${concept.definition.map(def => `<p>${def}</p>`).join('')}
                            </div>
                        </div>
                    `;
                }

                // Alternative labels
                if (concept.altLabel && concept.altLabel.length > 0) {
                    html += `
                        <div class="concept-section">
                            <div class="section-title">${this.translations.altLabels || 'Etichette alternative'}:</div>
                            <div class="section-content">
                                ${concept.altLabel.join(', ')}
                            </div>
                        </div>
                    `;
                }

                // Broader concepts
                if (concept.broaderConcept && concept.broaderConcept.length > 0) {
                    html += `
                        <div class="concept-section">
                            <div class="section-title">${this.translations.broaderConcepts || 'Concetti più generali'}:</div>
                            <div class="section-content">
                                ${this.renderConceptRelations(concept.broaderConcept)}
                            </div>
                        </div>
                    `;
                }

                // Narrower concepts
                if (concept.narrowerConcept && concept.narrowerConcept.length > 0) {
                    html += `
                        <div class="concept-section">
                            <div class="section-title">${this.translations.narrowerConcepts || 'Concetti più specifici'}:</div>
                            <div class="section-content">
                                ${this.renderConceptRelations(concept.narrowerConcept)}
                            </div>
                        </div>
                    `;
                }

                // Related concepts
                if (concept.related && concept.related.length > 0) {
                    html += `
                        <div class="concept-section">
                            <div class="section-title">${this.translations.relatedConcepts || 'Concetti correlati'}:</div>
                            <div class="section-content">
                                ${this.renderConceptRelations(concept.related)}
                            </div>
                        </div>
                    `;
                }

                // Notes
                const noteFields = [
                    { field: 'note', label: this.translations.notes || 'Note' },
                    { field: 'scopeNote', label: this.translations.scopeNotes || 'Note di ambito' },
                    { field: 'historyNote', label: this.translations.historyNotes || 'Note storiche' },
                    { field: 'editorialNote', label: this.translations.editorialNotes || 'Note editoriali' }
                ];

                noteFields.forEach(({ field, label }) => {
                    if (concept[field] && concept[field].length > 0) {
                        html += `
                            <div class="concept-section">
                                <div class="section-title">${label}:</div>
                                <div class="section-content">
                                    ${concept[field].map(note => `<p>${note}</p>`).join('')}
                                </div>
                            </div>
                        `;
                    }
                });

                // Examples
                if (concept.example && concept.example.length > 0) {
                    html += `
                        <div class="concept-section">
                            <div class="section-title">${this.translations.examples || 'Esempi'}:</div>
                            <div class="section-content">
                                ${concept.example.map(ex => `<p>${ex}</p>`).join('')}
                            </div>
                        </div>
                    `;
                }

                detailContainer.innerHTML = html;

                // Add click listeners to relation items
                document.querySelectorAll('.relation-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const conceptId = item.dataset.conceptId;
                        const conceptData = this.concepts[conceptId];
                        if (conceptData) {
                            this.selectedConcept = conceptId;
                            this.displayConceptDetail(conceptData);
                            // Update search input with new concept
                            document.getElementById('searchInput').value = conceptData.prefLabel;
                        }
                    });
                });
            }

            renderConceptRelations(relations) {
                return relations.map(relation => {
                    let label, conceptId;
                    if (typeof relation === 'object') {
                        label = Object.keys(relation)[0];
                        conceptId = Object.values(relation)[0];
                    } else {
                        conceptId = relation;
                        const conceptData = this.concepts[conceptId];
                        label = conceptData ? conceptData.prefLabel : conceptId;
                    }

                    return `<div class="relation-item" data-concept-id="${conceptId}">${label}</div>`;
                }).join('');
            }

            clearConceptList() {
                const defaultTitle = this.translations.listTitle || 'Seleziona una lettera o cerca un concetto';
                document.getElementById('listTitle').textContent = defaultTitle;
                document.getElementById('conceptItems').innerHTML = '';
            }

            clearConceptDetail() {
                const emptyText = this.translations.emptyState || 'Seleziona un concetto dalla lista per visualizzarne i dettagli';
                document.getElementById('emptyState').textContent = emptyText;
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('conceptDetail').style.display = 'none';
                this.selectedConcept = null;
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded, initializing SKOSClient');
            new SKOSClient();
        });
    </script>
</body>
</html>